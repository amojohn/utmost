<?xml version="1.0" encoding="utf-8"?>
<mx:Module xmlns:mx="http://www.adobe.com/2006/mxml" layout="vertical" width="100%" height="100%" creationComplete="init()">
	<mx:Script>
		<![CDATA[
			import org.utmost.tpl.TPLViewState;
			import org.utmost.util.TreeUtil;
			import mx.events.CloseEvent;
			import mx.controls.Alert;
			import mx.controls.TextInput;
			import org.utmost.util.AutoUtil;
			import org.utmost.service.UtmostService;
			import mx.controls.Tree;
			import org.utmost.tpl.ViewUtil;
			import mx.collections.ArrayCollection;
			import mx.rpc.events.ResultEvent;
			import org.utmost.service.AutoService;
			import org.utmost.util.ComponentUtil;
			
			private function init():void
			{
				TreeInit(tree);
				hideState();
			}
			public var _viewstate:String;
			public var tableName:String="U_ROLE";
			private function add():void
			{
				_viewstate=TPLViewState.M_ADD;
				viewInit("402881011f6807a6011f68e49ba400aa",TPLViewState.M_ADD);//角色
			}
			private function edit():void {
				_viewstate=TPLViewState.M_EDIT;
				viewInit("402881011f6807a6011f68e49ba400aa",TPLViewState.M_EDIT);//角色
			}
			private function viewInit(_cid:String,_mode:String):void {
				var service:AutoService=new AutoService();
				service.findByHql("from U_TPL_TEMPLATEVIEWBYADV v where v.cid='"+_cid+"' and v.view='"+_mode+"'",function (e:ResultEvent):void {
					var ac:ArrayCollection=e.result as ArrayCollection;
					trace(ac.length);
					vbox.removeAllChildren();
					//设置Form
					vbox.addChild(ViewUtil.buildForm(ac));
					var obj:Object=AutoUtil.getObjById("parentid",vbox);//*
					var uuid:String=tree.selectedItem.@uuid;
					if(uuid!=null&&uuid!="")
						(obj as TextInput).text=uuid;
					else 
						(obj as TextInput).text="0";
					showState();
					if(_mode==TPLViewState.M_EDIT) {
						var aservice:AutoService=new AutoService();
						aservice.findByUUID(tableName,tree.selectedItem.@uuid.toString(),function(event:ResultEvent):void{
							var oo:Object=(event.result as ArrayCollection).getItemAt(0);
							AutoUtil.fillValue(vbox,oo);
						});
					}
				});
			}
			private function TreeInit(_tree:Tree):void {
				var ut:UtmostService=new UtmostService("TreeService",function(e:ResultEvent):void{
					trace("e.result:"+e.result);
					var xml:XML=new XML(e.result);
					trace("xml:"+xml.toXMLString());
					_tree.dataProvider=xml;
					_tree.selectedIndex=0;
					callLater(function():void {
						ComponentUtil.ocAllTree(_tree);
						tree.selectedIndex=nowTreeSelectIndex;//设置Tree到上次选择状态
					});
				});
				ut.ro.getTree(TreeUtil.getRoleMainByTree(),TreeUtil.getRoleKvByTree());
			}

			private function submit():void {
				var rolecode:Object=AutoUtil.getObjById("rolecode",vbox);
				
				if(_viewstate==TPLViewState.M_ADD) {
					AutoService.unique(tableName,"rolecode",(rolecode as TextInput).text,function():void {
						saveOrUpdate();
					},function():void {
						(rolecode as TextInput).text="";
						Alert.show("角色编码已存在!","警告");
						return;
					});
				}else {
					saveOrUpdate();
				}
			}
			private var nowTreeSelectIndex:int;
			private function saveOrUpdate():void {
				nowTreeSelectIndex=tree.selectedIndex;
				var service:AutoService=new AutoService();
				service.autoSaveOrUpdate(tableName,vbox,function(e:ResultEvent):void{
						trace("success");
						TreeInit(tree);
						hideState();
					});
				
			}
			private function delNode():void {
				if(tree.selectedItem==null) {
					Alert.show("请选择节点");
					return;
				}
				var alert:Alert = Alert.show('确定删除节点以及子节点!', '信息提示', Alert.YES | Alert.NO); 
				alert.addEventListener(CloseEvent.CLOSE,function (e:CloseEvent):void {
					switch(e.detail) {
						case Alert.YES:
						var ut:UtmostService=new UtmostService("TreeService",function(event:ResultEvent):void {
							trace("成功");	
							TreeInit(tree);
						});
						var obj:Object=new Object();
						obj.tableName=tableName;//*
						obj.idField="uuid";//*
						obj.pidField="parentid";//*
						obj.idValue=tree.selectedItem.@uuid.toString();//*
						ut.ro.deleteTree(obj);
						//TreeInit(tree);
						break;
						case Alert.NO:
						break;	
					}
				}); 
			}
			private function showState():void {
				ComponentUtil.setVisible(vbox,true);
				ComponentUtil.setVisible(ambox,true);
			}
			private function hideState():void {
				ComponentUtil.setVisible(vbox,false);
				ComponentUtil.setVisible(ambox,false);
			}
		]]>
	</mx:Script>
	<mx:HBox width="100%" height="100%" horizontalAlign="center" verticalAlign="middle">
		<mx:Tree id="tree" width="400" height="90%" showRoot="true" labelField="@nodename" doubleClickEnabled="true" doubleClick="ComponentUtil.ocSelectTree(event)">
		</mx:Tree>
		<mx:VBox width="400" height="90%" horizontalAlign="left">
			<mx:VBox width="200" height="130">
				<mx:Button label="添加" click="add()"/>
				<mx:Button label="修改" click="edit()"/>
				<mx:Button label="删除" click="delNode()"/>
			</mx:VBox>
			<mx:VBox id="vbox" width="100%" height="50%">
			</mx:VBox>
			<mx:HBox id="ambox" width="100%" horizontalAlign="center" horizontalGap="30">
				<mx:Button label="确定" click="submit()"/>
				<mx:Button label="取消" click="hideState()"/>
			</mx:HBox>
		</mx:VBox>
	</mx:HBox>
</mx:Module>